<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Forest Products Transport Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f8f9fa;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
  }
  .search-box {
    margin-bottom: 20px;
    padding: 8px;
    width: 100%;
    max-width: 400px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: left;
    vertical-align: middle;
    font-size: 14px;
  }
  th {
    background-color: #007BFF;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  img {
    max-width: 100px;
    max-height: 80px;
    cursor: pointer;
    border-radius: 4px;
  }
  .charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }
  .chart-container {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    height: 300px;
  }
  .chart-container canvas {
    width: 100% !important;
    height: 100% !important;
  }
</style>
</head>
<body>

<h1>ðŸŒ² Forest Products Transport Dashboard</h1>

<input type="text" id="searchInput" class="search-box" placeholder="Search records..." onkeyup="filterTable()">

<table id="dataTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div class="charts">
  <div class="chart-container"><canvas id="chartKind"></canvas></div>
  <div class="chart-container"><canvas id="chartSpecies"></canvas></div>
  <div class="chart-container"><canvas id="chartTimeline"></canvas></div>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbyYReWmhvUY-ECqMaSEP2oNft1GzfjK01du-hNdUk_fn5KOaymGcebSDF0KREBzMJzvNQ/exec";

// Convert Google Drive link to direct image link
function convertDriveLink(url) {
  if (!url) return "";
  if (url.includes("open?id=")) {
    return url.replace("open?id=", "uc?export=view&id=");
  }
  const match = url.match(/\/d\/(.*?)\//);
  if (match) {
    return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  }
  return url;
}

// Format date into "Mon DD, YYYY HH:mm"
function formatDate(value) {
  if (!value) return "";
  let d;

  // If numeric, treat as Excel serial date
  if (!isNaN(value) && value > 1000 && value < 60000) {
    d = new Date((value - 25569) * 86400 * 1000);
  } else {
    d = new Date(value);
  }

  if (isNaN(d)) return value;

  const options = { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' };
  return d.toLocaleString(undefined, options);
}

fetch(DATA_URL)
  .then(response => response.json())
  .then(data => {
    if (!Array.isArray(data) || data.length === 0) {
      alert("No data available");
      return;
    }

    // Normalize column names
    const normalizedData = data.map(row => {
      const newRow = {};
      Object.keys(row).forEach(k => {
        newRow[k.trim().toLowerCase()] = row[k];
      });
      return newRow;
    });

    const headers = Object.keys(data[0]);
    const tableHeader = document.getElementById("tableHeader");
    const tableBody = document.getElementById("tableBody");

    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      tableHeader.appendChild(th);
    });

    normalizedData.forEach(row => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const key = h.trim().toLowerCase();
        const td = document.createElement("td");

        if (key.includes("photo")) {
          const url = row[key];
          if (url) {
            const img = document.createElement("img");
            img.src = convertDriveLink(url);
            img.onclick = () => window.open(url, "_blank");
            td.appendChild(img);
          }
        } 
        else if (key.includes("timestamp") || key === "date") {
          td.textContent = formatDate(row[key]);
        }
        else {
          td.textContent = row[key] || "";
        }
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });

    // Auto-detect keys
    const kindKey = Object.keys(normalizedData[0]).find(k => k.includes("kind"));
    const speciesKey = Object.keys(normalizedData[0]).find(k => k.includes("species"));
    const dateKey = Object.keys(normalizedData[0]).find(k => k.includes("date"));

    // Prepare chart data
    const kindCounts = {};
    const speciesCounts = {};
    const dateCounts = {};

    normalizedData.forEach(row => {
      const kind = row[kindKey] || "Unknown";
      kindCounts[kind] = (kindCounts[kind] || 0) + 1;

      const species = row[speciesKey] || "Unknown";
      speciesCounts[species] = (speciesCounts[species] || 0) + 1;

      let dateValue = row[dateKey];
      if (dateValue && !isNaN(new Date(dateValue))) {
        const d = new Date(dateValue);
        const monthYear = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        dateCounts[monthYear] = (dateCounts[monthYear] || 0) + 1;
      }
    });

    makeChart("chartKind", "bar", Object.keys(kindCounts), Object.values(kindCounts), "Number of Records by Kind");
    makeChart("chartSpecies", "pie", Object.keys(speciesCounts), Object.values(speciesCounts), "Species Distribution");
    makeChart("chartTimeline", "line", Object.keys(dateCounts), Object.values(dateCounts), "Records Over Time");
  })
  .catch(err => console.error("Error fetching data:", err));

function makeChart(canvasId, type, labels, data, label) {
  new Chart(document.getElementById(canvasId), {
    type,
    data: {
      labels,
      datasets: [{
        label,
        data,
        backgroundColor: type === "pie" ? generateColors(labels.length) : "#28a745",
        borderColor: "#28a745",
        fill: type === "line" ? false : true
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: type === "pie" } },
      scales: type !== "pie" ? { y: { beginAtZero: true } } : {}
    }
  });
}

function generateColors(n) {
  return Array.from({ length: n }, (_, i) => `hsl(${i * 360 / n}, 70%, 50%)`);
}

function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tbody tr");
  rows.forEach(row => {
    const cells = Array.from(row.getElementsByTagName("td"));
    row.style.display = cells.some(cell => cell.textContent.toLowerCase().includes(searchValue)) ? "" : "none";
  });
}
</script>

</body>
</html>
