<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forest Products Transport Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 0;
  }
  header {
    background: #007bff;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 1.5em;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .container {
    padding: 20px;
    max-width: 1400px;
    margin: auto;
  }
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
  }
  select, input[type="text"] {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    min-width: 150px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }
  th {
    background: #007bff;
    color: white;
  }
  tr:nth-child(even) {
    background: #f9f9f9;
  }
  img {
    max-width: 80px;
    max-height: 60px;
    border-radius: 4px;
    cursor: pointer;
  }
  .charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }
  canvas {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  /* Lightbox */
  .lightbox {
    position: fixed;
    display: none;
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.8);
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 1000;
  }
  .lightbox img {
    max-width: 90%;
    max-height: 90%;
  }
</style>
</head>
<body>

<header>ðŸŒ² Forest Products Transport Dashboard</header>

<div class="container">
  <!-- Filters -->
  <div class="filters">
    <input type="text" id="searchInput" placeholder="Search..." onkeyup="applyFilters()">
    <select id="filterKind" onchange="applyFilters()"><option value="">All Kinds</option></select>
    <select id="filterSpecies" onchange="applyFilters()"><option value="">All Species</option></select>
    <select id="filterCENRO" onchange="applyFilters()"><option value="">All CENRO</option></select>
    <select id="filterDestination" onchange="applyFilters()"><option value="">All Destinations</option></select>
  </div>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- Charts -->
  <div class="charts">
    <canvas id="chartKind"></canvas>
    <canvas id="chartSpecies"></canvas>
    <canvas id="chartTimeline"></canvas>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="this.style.display='none'">
  <img id="lightboxImg" src="">
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbyYReWmhvUY-ECqMaSEP2oNft1GzfjK01du-hNdUk_fn5KOaymGcebSDF0KREBzMJzvNQ/exec";
let originalData = [];

function convertDriveLink(url) {
  if (!url) return "";
  if (url.includes("open?id=")) return url.replace("open?id=", "uc?export=view&id=");
  const match = url.match(/\/d\/(.*?)\//);
  if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  return url;
}

fetch(DATA_URL)
  .then(r => r.json())
  .then(data => {
    originalData = data;
    buildTable(data);
    populateFilters(data);
    updateCharts(data);
  });

function buildTable(data) {
  const tableHeader = document.getElementById("tableHeader");
  const tableBody = document.getElementById("tableBody");
  tableHeader.innerHTML = "";
  tableBody.innerHTML = "";

  if (!data.length) return;

  const headers = Object.keys(data[0]);
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    tableHeader.appendChild(th);
  });

  data.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      if (h.toLowerCase().includes("photo")) {
        const url = row[h];
        if (url) {
          const img = document.createElement("img");
          img.src = convertDriveLink(url);
          img.onclick = e => {
            e.stopPropagation();
            document.getElementById("lightboxImg").src = convertDriveLink(url);
            document.getElementById("lightbox").style.display = "flex";
          };
          td.appendChild(img);
        }
      } else {
        td.textContent = row[h] || "";
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

function populateFilters(data) {
  fillSelect("filterKind", [...new Set(data.map(r => r["Kind of Forest Products"]).filter(Boolean))]);
  fillSelect("filterSpecies", [...new Set(data.map(r => r["Species"]).filter(Boolean))]);
  fillSelect("filterCENRO", [...new Set(data.map(r => r["CENRO-Origin"]).filter(Boolean))]);
  fillSelect("filterDestination", [...new Set(data.map(r => r["Destination -Address/Location"]).filter(Boolean))]);
}

function fillSelect(id, values) {
  const select = document.getElementById(id);
  values.sort().forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    select.appendChild(opt);
  });
}

function applyFilters() {
  const searchVal = document.getElementById("searchInput").value.toLowerCase();
  const kind = document.getElementById("filterKind").value;
  const species = document.getElementById("filterSpecies").value;
  const cenro = document.getElementById("filterCENRO").value;
  const dest = document.getElementById("filterDestination").value;

  const filtered = originalData.filter(row => {
    return (!kind || row["Kind of Forest Products"] === kind) &&
           (!species || row["Species"] === species) &&
           (!cenro || row["CENRO-Origin"] === cenro) &&
           (!dest || row["Destination -Address/Location"] === dest) &&
           Object.values(row).some(val => (val || "").toString().toLowerCase().includes(searchVal));
  });

  buildTable(filtered);
  updateCharts(filtered);
}

function updateCharts(data) {
  makeChart("chartKind", "bar", countBy(data, "Kind of Forest Products"), "Number of Records by Kind");
  makeChart("chartSpecies", "pie", countBy(data, "Species"), "Species Distribution");
  makeChart("chartTimeline", "line", countBy(data, "DATE"), "Permits Over Time");
}

function countBy(data, field) {
  const counts = {};
  data.forEach(row => {
    const key = row[field] || "Unknown";
    counts[key] = (counts[key] || 0) + 1;
  });
  return { labels: Object.keys(counts), values: Object.values(counts) };
}

let chartInstances = {};
function makeChart(canvasId, type, dataset, label) {
  if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
  chartInstances[canvasId] = new Chart(document.getElementById(canvasId), {
    type,
    data: {
      labels: dataset.labels,
      datasets: [{
        label,
        data: dataset.values,
        backgroundColor: type === "pie" ? dataset.labels.map(() => randomColor()) : "#28a745",
        borderColor: "#fff",
        borderWidth: 1
      }]
    },
    options: { responsive: true, plugins: { legend: { display: type === "pie" } } }
  });
}

function randomColor() {
  return `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
}
</script>
</body>
</html>
